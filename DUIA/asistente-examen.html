<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DUIA - Examen</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --azul-unju: #003366;
      --rojo: #d44e41;
      --gris: #f4f6f9;
      --blanco: #ffffff;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--gris);
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--blanco);
      padding: 10px 20px;
      border-bottom: 4px solid var(--azul-unju);
    }
    header img { height: 50px; }
    header h1 {
      color: var(--azul-unju);
      font-size: 1.2rem;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    .timer {
      font-weight: bold;
      color: var(--rojo);
      text-align: right;
    }
    .pregunta {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 20px;
    }
    .opcion {
      display: block;
      margin: 10px auto;
      padding: 12px;
      background: #f0f0f0;
      border: 2px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      max-width: 400px;
    }
    #resultadoFinal {
      font-size: 1.2rem;
      margin-top: 20px;
    }
    input, select {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 80%;
      max-width: 400px;
      font-size: 1rem;
    }
    #identificacion button, button {
      background-color: var(--azul-unju);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>
<header>
  <img src="logo-fi-unju-institucional-horizontal-786x202.png" alt="Logo UNJu">
  <h1>SIED - Facultad de Ingeniería - UNJu</h1>
</header>

<div class="container" id="identificacion">
  <h2>👤 Ingreso al Examen</h2>
  <input type="text" id="nombre" placeholder="Nombre completo" required />
  <input type="text" id="codigo" placeholder="Código institucional" required />
  <select id="rol">
    <option value="alumno">Alumno</option>
    <option value="docente">Docente</option>
  </select>
  <button onclick="iniciarExamen()">Comenzar Examen</button>
</div>

<div class="container" style="display:none;" id="contenido-container">
  <div class="timer" id="temporizador"></div>
  <div class="pregunta" id="pregunta"></div>
  <div id="opciones"></div>
  <div id="resultadoFinal"></div>
</div>

<div class="container">
  <h3>📊 Respuestas Registradas</h3>
  <select id="filtroMateria" onchange="mostrarTablaRespuestas()">
    <option value="">Todas las materias</option>
    <option value="Matemática">Matemática</option>
    <option value="Lengua">Lengua</option>
    <option value="Historia">Historia</option>
    <!-- Agregá más si lo necesitás -->
  </select>
  <button onclick="mostrarTablaRespuestas()">Ver respuestas</button>
  <div id="tablaRespuestas"></div>
</div>

<script>
const supabase = supabase.createClient(
  'https://nindbkahmhbutpizbgpg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbmRia2FobWhidXRwaXpiZ3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODExMTEsImV4cCI6MjA2Njk1NzExMX0.WcaK-r_cHb5rmImb4DDbYmOXi6uz05GJurBu1d21vsQ'
);

let preguntas = [], indice = 0, puntaje = 0, tiempo = 30, temporizadorID;
let nombre = "", codigo = "", rol = "";

async function iniciarExamen() {
  nombre = document.getElementById('nombre').value.trim();
  codigo = document.getElementById('codigo').value.trim();
  rol = document.getElementById('rol').value;

  if (!nombre || !codigo) return alert('Por favor, completá todos los campos.');

  const { data, error } = await supabase.from('preguntas').select('*').limit(10);
  if (error || !data.length) {
    document.getElementById('pregunta').innerText = '❌ No se pudieron cargar preguntas.';
    return;
  }

  preguntas = data;
  document.getElementById('identificacion').style.display = 'none';
  document.getElementById('contenido-container').style.display = 'block';
  indice = 0; puntaje = 0;
  siguientePregunta();
}

function siguientePregunta() {
  if (indice >= preguntas.length) return mostrarResultado();

  const p = preguntas[indice];
  document.getElementById('pregunta').textContent = p.pregunta || 'Sin texto';
  const opcionesDiv = document.getElementById('opciones');
  opcionesDiv.innerHTML = '';

  let opciones = [];
  try { opciones = JSON.parse(p.opciones || '[]'); } catch {}

  opciones.forEach(op => {
    const btn = document.createElement('button');
    btn.className = 'opcion';
    btn.textContent = op;
    btn.onclick = () => responder(op, p);
    opcionesDiv.appendChild(btn);
  });

  iniciarTemporizador();
}

function iniciarTemporizador() {
  tiempo = 30;
  actualizarTemporizador();
  temporizadorID = setInterval(() => {
    tiempo--;
    actualizarTemporizador();
    if (tiempo <= 0) {
      clearInterval(temporizadorID);
      guardarRespuesta(null, preguntas[indice], false);
      indice++;
      siguientePregunta();
    }
  }, 1000);
}

function actualizarTemporizador() {
  document.getElementById('temporizador').textContent = `⏱ Tiempo restante: ${tiempo}s`;
}

function responder(opcion, pregunta) {
  clearInterval(temporizadorID);
  const esCorrecta = opcion === pregunta.respuesta_correcta;
  if (esCorrecta) puntaje++;
  guardarRespuesta(opcion, pregunta, esCorrecta);
  indice++;
  siguientePregunta();
}

function mostrarResultado() {
  document.getElementById('pregunta').innerHTML = '';
  document.getElementById('opciones').innerHTML = '';
  document.getElementById('temporizador').innerHTML = '';
  document.getElementById('resultadoFinal').textContent =
    `📘 Has finalizado el examen. Obtuviste ${puntaje} de ${preguntas.length} respuestas correctas.`;
}

async function guardarRespuesta(respuesta, pregunta, esCorrecta) {
  await supabase.from('respuestas').insert({
    pregunta_id: pregunta.id,
    respuesta: respuesta || 'Sin respuesta',
    modo: 'examen',
    fecha: new Date().toISOString(),
    curso: 'Curso 1',
    materia: pregunta.materia || 'Matemática',
    nombre,
    codigo,
    rol
  });
}

async function mostrarTablaRespuestas() {
  const contenedor = document.getElementById("tablaRespuestas");
  contenedor.innerHTML = "🔄 Cargando respuestas...";

  const filtro = document.getElementById("filtroMateria").value;
  let query = supabase.from("respuestas").select("*").order("fecha", { ascending: false }).limit(50);
  if (filtro) query = query.eq("materia", filtro);

  const { data, error } = await query;

  if (error) {
    contenedor.innerHTML = "❌ Error al cargar las respuestas.";
    console.error(error);
    return;
  }

  if (!data.length) {
    contenedor.innerHTML = "⚠️ No hay respuestas registradas.";
    return;
  }

  let tabla = `<table><tr>
    <th>🆔</th><th>Pregunta ID</th><th>Respuesta</th>
    <th>Modo</th><th>Curso</th><th>Materia</th><th>Fecha</th>
  </tr>`;
  data.forEach(r => {
    tabla += `<tr>
      <td>${r.id}</td><td>${r.pregunta_id}</td><td>${r.respuesta}</td>
      <td>${r.modo}</td><td>${r.curso}</td><td>${r.materia}</td>
      <td>${new Date(r.fecha).toLocaleString()}</td>
    </tr>`;
  });
  tabla += "</table>";
  contenedor.innerHTML = tabla;
}
</script>
</body>
</html>
