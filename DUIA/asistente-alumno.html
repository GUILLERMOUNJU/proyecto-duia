<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DUIA - Asistente Alumno</title>
  <style>
    :root {
      --azul-unju: #003366;
      --rojo: #d44e41;
      --gris: #f4f6f9;
      --blanco: #ffffff;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--gris);
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--blanco);
      padding: 10px 20px;
      border-bottom: 4px solid var(--azul-unju);
    }
    header img { height: 50px; }
    header h1 {
      color: var(--azul-unju);
      font-size: 1.2rem;
      margin: 0;
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      padding: 20px;
      background: var(--blanco);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .timer {
      font-weight: bold;
      color: var(--rojo);
      text-align: right;
      margin-bottom: 10px;
    }
    .pregunta {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .opcion {
      display: block;
      margin: 10px 0;
      padding: 12px;
      background: #f0f0f0;
      border: 2px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
    }
    .voz, .microfono {
      font-size: 1.2rem;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 6px;
    }
    .feedback {
      margin-top: 10px;
      font-weight: bold;
    }
    .correcto { color: green; }
    .incorrecto { color: red; }
    #resultadoFinal {
      font-size: 1.2rem;
      text-align: center;
      margin-top: 20px;
    }
    #modo-selector {
      text-align: center;
      margin-top: 30px;
    }
    #modo-selector button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1rem;
      background-color: var(--azul-unju);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <img src="logo-fi-unju-institucional-horizontal-786x202.png" alt="Logo UNJu">
  <h1>SIED - Facultad de Ingenier√≠a - UNJu</h1>
</header>
<div class="container" id="modo-selector">
  <h2>Elige un modo para comenzar</h2>
  <button onclick="iniciar('practica')">üß™ Pr√°ctica (con ayuda)</button>
  <button onclick="iniciar('examen')">üìù Examen (con tiempo)</button>
</div>
<div class="container" style="display:none;" id="contenido-container">
  <div class="timer" id="temporizador"></div>
  <div id="contenido"></div>
  <div id="resultadoFinal"></div>
</div>
<script>
const supabase = supabase.createClient(
  'https://nindbkahmhbutpizbgpg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbmRia2FobWhidXRwaXpiZ3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODExMTEsImV4cCI6MjA2Njk1NzExMX0.WcaK-r_cHb5rmImb4DDbYmOXi6uz05GJurBu1d21vsQ'
);

let preguntas = [
  {
    texto: "¬øCu√°l es la capital de Francia?",
    opciones: ["Par√≠s", "Madrid", "Roma", "Lisboa"],
    respuesta_correcta: "Par√≠s",
    fundamento: "Par√≠s es la capital y ciudad m√°s poblada de Francia."
  },
  {
    texto: "¬øCu√°nto es 2 + 2?",
    opciones: ["3", "4", "5", "2"],
    respuesta_correcta: "4",
    fundamento: "2 + 2 es una suma b√°sica que da como resultado 4."
  }
];

let indice = 0;
let puntaje = 0;
let modoJuego = "practica";
let tiempoPorPregunta = 30;
let tiempoRestante;
let temporizadorID;

function iniciar(modo) {
  modoJuego = modo;
  document.getElementById('modo-selector').style.display = 'none';
  document.getElementById('contenido-container').style.display = 'block';
  indice = 0;
  puntaje = 0;
  iniciarPregunta();
}

function iniciarPregunta() {
  if (indice >= preguntas.length) return mostrarResultado();
  const contenedor = document.getElementById('contenido');
  const p = preguntas[indice];
  contenedor.innerHTML = '';

  const h2 = document.createElement('div');
  h2.className = 'pregunta';
  h2.innerHTML = `${p.texto} <button class="voz" onclick="leer('${p.texto}')">üîä</button>`;
  contenedor.appendChild(h2);

  p.opciones.forEach(op => {
    const btn = document.createElement('button');
    btn.className = 'opcion';
    btn.innerHTML = `${op} <button class="voz" onclick=\"event.stopPropagation();leer('${op}')\">üîä</button>`;
    btn.onclick = () => seleccionar(op);
    contenedor.appendChild(btn);
  });

  const mic = document.createElement('button');
  mic.className = 'microfono';
  mic.textContent = 'üé§';
  mic.onclick = escuchar;
  contenedor.appendChild(mic);

  if (modoJuego === 'examen') iniciarTemporizador();
  else document.getElementById('temporizador').textContent = '';
}

async function seleccionar(opcion) {
  detenerTemporizador();
  const contenedor = document.getElementById('contenido');
  const p = preguntas[indice];
  const correcto = opcion === p.respuesta_correcta;
  if (correcto) puntaje++;

  await guardarRespuesta(p.texto, opcion, p.respuesta_correcta, correcto);
  if (modoJuego === 'practica') {
    const f = document.createElement('div');
    f.className = 'feedback ' + (correcto ? 'correcto' : 'incorrecto');
    f.textContent = correcto ? '‚úÖ Correcto' : `‚ùå Incorrecto. La respuesta correcta es: ${p.respuesta_correcta}`;
    contenedor.appendChild(f);

    const expl = document.createElement('div');
    expl.textContent = 'üß† ' + p.fundamento;
    contenedor.appendChild(expl);

    setTimeout(() => {
      indice++;
      iniciarPregunta();
    }, 3000);
  } else {
    indice++;
    iniciarPregunta();
  }
}

function mostrarResultado() {
  document.getElementById('contenido').innerHTML = '';
  document.getElementById('temporizador').innerHTML = '';
  document.getElementById('resultadoFinal').textContent = `Has completado el ${modoJuego}. Obtuviste ${puntaje} de ${preguntas.length} correctas.`;
}

function leer(texto) {
  if ('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance(texto);
    u.lang = 'es-ES';
    speechSynthesis.speak(u);
  }
}

function escuchar() {
  if (!('webkitSpeechRecognition' in window)) return alert("Tu navegador no soporta reconocimiento de voz.");
  const rec = new webkitSpeechRecognition();
  rec.lang = 'es-ES';
  rec.onresult = e => {
    const dicho = e.results[0][0].transcript.trim();
    const op = preguntas[indice].opciones.find(o => o.toLowerCase() === dicho.toLowerCase());
    if (op) seleccionar(op);
    else alert("No se reconoci√≥ una opci√≥n v√°lida: " + dicho);
  };
  rec.start();
}

function iniciarTemporizador() {
  tiempoRestante = tiempoPorPregunta;
  actualizarTemporizador();
  temporizadorID = setInterval(() => {
    tiempoRestante--;
    actualizarTemporizador();
    if (tiempoRestante <= 0) {
      detenerTemporizador();
      indice++;
      iniciarPregunta();
    }
  }, 1000);
}

function actualizarTemporizador() {
  document.getElementById('temporizador').textContent = `Tiempo restante: ${tiempoRestante}s`;
}

async function guardarRespuesta(pregunta, respuesta, correcta, esCorrecta) {
  const { error } = await supabase.from('respuestas').insert([
    {
      pregunta_id: null,
      respuesta: respuesta,
      modo: modoJuego,
      fecha: new Date().toISOString(),
      origen: window.navigator.userAgent,
      es_correcta: esCorrecta,
      texto_pregunta: pregunta,
      curso: 'Curso 1',
      materia: 'Matem√°tica'
    }
  ]);
  if (error) console.error('Error al guardar respuesta:', error);
}

function detenerTemporizador() {
  clearInterval(temporizadorID);
}

window.onblur = () => {
  if (modoJuego === 'examen') {
    detenerTemporizador();
    indice++;
    iniciarPregunta();
  }
};
</script>
</body>
</html>
