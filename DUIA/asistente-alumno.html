<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DUIA - Asistente Educativo</title>
  <style>
    /* ... AcÃ¡ va todo tu CSS anterior, lo podÃ©s mantener sin modificar ... */
  </style>
</head>
<body>
  <div class="main-container">
    <header class="quiz-header"><h1>SIED - Facultad de IngenierÃ­a - UNJu</h1></header>
    <div id="modo-inicio-container">
      <main class="quiz-card modo-inicio-card">
        <h2>Elige un modo para comenzar</h2>
        <button class="btn-modo btn-entrenamiento">PrÃ¡ctica (con ayuda)</button>
        <button class="btn-modo btn-examen">Examen (con tiempo)</button>
      </main>
    </div>
    <div id="quiz-container" style="display:none;">
      <main class="quiz-card">
        <div id="timer"></div>
        <div id="progreso" style="text-align:center; color:white; margin-bottom:10px;"></div>
        <div class="question-area">
          <span class="speaker-icon" id="speaker-btn" title="Leer pregunta">ðŸ”Š</span>
          <h2 class="question-text" id="question-text"></h2>
        </div>
        <div class="options-container" id="options-container"></div>
        <div class="feedback-area" id="feedback-area">
          <p class="title" id="feedback-title"></p>
          <p class="explanation" id="feedback-explanation"></p>
        </div>
        <div class="actions-container">
          <button class="mic-btn" id="mic-btn" title="Responder por voz">ðŸŽ¤</button>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://nindbkahmhbutpizbgpg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbmRia2FobWhidXRwaXpiZ3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODExMTEsImV4cCI6MjA2Njk1NzExMX0.WcaK-r_cHb5rmImb4DDbYmOXi6uz05GJurBu1d21vsQ'
    )

    let todasLasPreguntas = [], preguntaActualIndex = 0, modoJuego = '', timerInterval, tiempoRestante = 600, puntaje = 0
    const questionTextEl = document.getElementById('question-text'),
          optionsContainerEl = document.getElementById('options-container'),
          feedbackAreaEl = document.getElementById('feedback-area'),
          feedbackTitleEl = document.getElementById('feedback-title'),
          feedbackExplanationEl = document.getElementById('feedback-explanation'),
          speakerBtn = document.getElementById('speaker-btn'),
          micBtn = document.getElementById('mic-btn'),
          timerEl = document.getElementById('timer'),
          progresoEl = document.getElementById('progreso')

    document.querySelector('.btn-entrenamiento').addEventListener('click', () => iniciarQuiz('practica'))
    document.querySelector('.btn-examen').addEventListener('click', () => iniciarQuiz('examen'))

    async function iniciarQuiz(modo) {
      modoJuego = modo
      document.getElementById('modo-inicio-container').style.display = 'none'
      document.getElementById('quiz-container').style.display = 'block'
      if (modo === 'examen') {
        timerEl.style.display = 'block'
        iniciarTimer()
      }

      const { data, error } = await supabase
        .from('preguntas')
        .select('*')
        .eq('modo', modoJuego)
        .order('id', { ascending: true })

      if (error || !data || data.length === 0) {
        questionTextEl.textContent = 'No se encontraron preguntas.'
        return
      }

      todasLasPreguntas = data
      preguntaActualIndex = 0
      puntaje = 0
      mostrarPregunta()
    }

    function iniciarTimer() {
      if (timerInterval) clearInterval(timerInterval)
      tiempoRestante = 600
      timerInterval = setInterval(actualizarTimer, 1000)
    }

    function actualizarTimer() {
      tiempoRestante--
      const m = Math.floor(tiempoRestante / 60)
      const s = tiempoRestante % 60
      timerEl.textContent = `Tiempo: ${m}:${s < 10 ? '0' + s : s}`
      if (tiempoRestante <= 0) finalizarQuiz(true)
    }

    function mostrarPregunta() {
      resetearEstado()
      const pregunta = todasLasPreguntas[preguntaActualIndex]
      progresoEl.textContent = `Pregunta ${preguntaActualIndex + 1} de ${todasLasPreguntas.length}`
      questionTextEl.textContent = pregunta.texto_pregunta
      optionsContainerEl.innerHTML = ''

      pregunta.opciones.forEach(opcionTexto => {
        const wrapper = document.createElement('div')
        wrapper.className = 'option-wrapper'

        const button = document.createElement('button')
        button.textContent = opcionTexto
        button.className = 'option'
        button.addEventListener('click', e => seleccionarOpcion(e.target))

        const optionSpeaker = document.createElement('span')
        optionSpeaker.className = 'speaker-icon option-speaker'
        optionSpeaker.textContent = 'ðŸ”Š'
        optionSpeaker.title = 'Leer opciÃ³n'
        optionSpeaker.addEventListener('click', e => {
          e.stopPropagation()
          hablar(opcionTexto)
        })

        wrapper.appendChild(button)
        wrapper.appendChild(optionSpeaker)
        optionsContainerEl.appendChild(wrapper)
      })
    }

    function seleccionarOpcion(botonSeleccionado) {
      document.querySelectorAll('.option').forEach(b => b.disabled = true)
      micBtn.disabled = true
      const pregunta = todasLasPreguntas[preguntaActualIndex]
      const esCorrecta = botonSeleccionado.textContent === pregunta.respuesta_correcta

      if (esCorrecta) puntaje++

      if (modoJuego === 'practica') {
        botonSeleccionado.classList.add(esCorrecta ? 'correct' : 'incorrect')
        if (!esCorrecta) {
          const botonCorrecto = Array.from(optionsContainerEl.querySelectorAll('.option'))
            .find(b => b.textContent === pregunta.respuesta_correcta)
          if (botonCorrecto) botonCorrecto.classList.add('correct')
        }
        mostrarFeedback(esCorrecta, pregunta.fundamento)
      }

      // Guardar respuesta (futuro)
      /*
      await supabase.from('respuestas').insert({
        alumno_id: 'anonimo',
        pregunta_id: pregunta.id,
        respuesta_dada: botonSeleccionado.textContent,
        correcta: esCorrecta,
        modo: modoJuego
      })
      */

      setTimeout(siguientePregunta, modoJuego === 'practica' ? 3500 : 800)
    }

    function mostrarFeedback(esCorrecta, explicacion) {
      feedbackAreaEl.className = `feedback-area ${esCorrecta ? 'correct' : 'incorrect'}`
      feedbackTitleEl.textContent = esCorrecta ? 'Â¡Correcto!' : 'Incorrecto'
      const pregunta = todasLasPreguntas[preguntaActualIndex]
      feedbackExplanationEl.textContent = esCorrecta ? explicacion : `La respuesta correcta es: "${pregunta.respuesta_correcta}". ${explicacion}`
      feedbackAreaEl.style.display = 'block'
    }

    function siguientePregunta() {
      preguntaActualIndex++
      preguntaActualIndex < todasLasPreguntas.length ? mostrarPregunta() : finalizarQuiz(false)
    }

    function finalizarQuiz(porTiempo) {
      clearInterval(timerInterval)
      questionTextEl.textContent = 'Â¡Cuestionario finalizado!'
      let resultadoHTML = ''
      if (porTiempo) resultadoHTML = '<p style="text-align:center; font-size:1.2rem;">Â¡Se acabÃ³ el tiempo!</p>'
      const porcentaje = ((puntaje / todasLasPreguntas.length) * 100).toFixed(0)
      resultadoHTML += `<p style
